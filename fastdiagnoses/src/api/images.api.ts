// images.api.ts (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import { fetchClient } from './fetchClient';
import { APIResponse } from '../types/api.types';
import { UploadedImage } from '../types/api.types';

export const imagesApi = {
  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ë–ï–ó –ª–æ–≥–∏–Ω–∞ - —Å–µ—Ä–≤–µ—Ä –±–µ—Ä–µ—Ç –∏–∑ —Ç–æ–∫–µ–Ω–∞)
   */
  async getUserImages(): Promise<APIResponse & { data?: UploadedImage[] }> {
    try {
      console.log('üì• –ó–∞–ø—Ä–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
      
      const response = await fetchClient.getImages();
      
      if (response.success && response.data) {
        return {
          success: true,
          data: response.data.images || [],
        };
      }
      
      return {
        success: false,
        message: response.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
      };
      
    } catch (error: any) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
      return {
        success: false,
        message: error.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
      };
    }
  },

  /**
   * –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ë–ï–ó –ª–æ–≥–∏–Ω–∞ - —Å–µ—Ä–≤–µ—Ä –±–µ—Ä–µ—Ç –∏–∑ —Ç–æ–∫–µ–Ω–∞)
   */
  async uploadImage(file: File, comment?: string): Promise<APIResponse> {
    try {
      console.log(`üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${file.name}`);
      
      const base64Data = await convertFileToBase64(file);
      
      const result = await fetchClient.uploadImageBase64(
        file.name,
        base64Data,
        comment || ''
      );
      
      if (result.success) {
        console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${file.name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`);
        return {
          success: true,
          message: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ',
        };
      } else {
        return {
          success: false,
          message: result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
        };
      }
    } catch (error: any) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      return {
        success: false,
        message: error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞',
      };
    }
  },

  /**
   * –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ë–ï–ó –ª–æ–≥–∏–Ω–∞ - —Å–µ—Ä–≤–µ—Ä –±–µ—Ä–µ—Ç –∏–∑ —Ç–æ–∫–µ–Ω–∞)
   */
  async deleteImage(id: number): Promise<APIResponse> {
    try {
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${id}...`);
      
      const response = await fetchClient.deleteSurveyOrImage(id);
      
      return response;
      
    } catch (error: any) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      return {
        success: false,
        message: error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
      };
    }
  },

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ ID (–ë–ï–ó –ª–æ–≥–∏–Ω–∞ - —Å–µ—Ä–≤–µ—Ä –±–µ—Ä–µ—Ç –∏–∑ —Ç–æ–∫–µ–Ω–∞)
   */
  async getImageById(id: number): Promise<APIResponse & { data?: { filename: string, image: string } }> {
    try {
      console.log(`üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å ID: ${id}`);
      
      const response = await fetchClient.getImageById(id);
      
      if (response.success && response.data) {
        return {
          success: true,
          data: response.data,
        };
      }
      
      return {
        success: false,
        message: response.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
      };
      
    } catch (error: any) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      return {
        success: false,
        message: error.message || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
      };
    }
  }
};

const convertFileToBase64 = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64String = (reader.result as string).split(',')[1];
      resolve(base64String);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

// –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
export const getUserImages = imagesApi.getUserImages;
export const uploadImage = imagesApi.uploadImage;
export const deleteImage = imagesApi.deleteImage;
export const getImageById = imagesApi.getImageById;

// –≠–∫—Å–ø–æ—Ä—Ç –æ–±—ä–µ–∫—Ç–∞ API –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥—É–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ
export default imagesApi;