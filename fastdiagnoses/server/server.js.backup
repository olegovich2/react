const express = require("express");
const path = require("path");
const cors = require("cors");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const emailService = require("./src/utils/emailService");
const validator = require("validator");
const fs = require("fs").promises;
const crypto = require("crypto");
const workerService = require("./src/services/workerService");
require("dotenv").config();
const { authenticateToken } = require("./src/middleware/auth");
const passwordResetService = require("./src/services/passwordResetService");
const userTableService = require("./src/services/userTableService");
const config = require("./src/config");
const {
  ValidationError,
  validateLogin,
  validatePassword,
  validateEmail,
  validateSurvey,
  validateImageBuffer,
  validateSecretWord,
} = require("./src/utils/validators");
const {
  ensureUploadDirs,
  deleteImageFromDisk,
} = require("./src/utils/fileSystem");
const { uploadSingleImage } = require("./src/utils/uploadConfig");
const { startCleanupSchedule } = require("./src/utils/cron");
const { query, getConnection } = require("./src/services/databaseService");
const { HTML_TEMPLATES } = require("./src/templates/htmlTemplates");

// =====================ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ðµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹=============
const apiRoutes = require("./src/routes/index");

// ==================== ÐÐ”ÐœÐ˜Ð Ð˜ÐœÐŸÐžÐ Ð¢Ð« ====================
const adminRoutes = require("./src/admin/routes/adminRoutes");
// ==================== Ð¢Ð•Ð¥ÐŸÐžÐ”Ð”Ð•Ð Ð–ÐšÐ Ð˜ÐœÐŸÐžÐ Ð¢Ð« ===================
const supportRoutes = require("./src/support/routes/supportRoutes");

const app = express();
const PORT = process.env.PORT || 5000;

// ==================== Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð•Ðœ ÐšÐžÐÐ¤Ð˜Ð“Ð˜ ====================
const MAX_USERS_PER_EMAIL = config.MAX_USERS_PER_EMAIL;
const UPLOAD_DIR = config.UPLOAD_DIR;
const JWT_SECRET = config.JWT_SECRET;
const JWT_SECRET_TWO = config.JWT_SECRET_TWO;

// ==================== MIDDLEWARE ====================
app.use(
  cors({
    origin:
      process.env.NODE_ENV === "production"
        ? process.env.CLIENT_URL
        : "http://localhost:5000",
    credentials: true,
  })
);

app.use(express.json({ limit: "10mb" }));
app.use(express.urlencoded({ extended: true }));
app.use("/uploads", express.static(UPLOAD_DIR));

const buildPath = path.join(__dirname, "..", "client", "build");
app.use(express.static(buildPath));

const adminBuildPath = path.join(__dirname, "..", "client-admin", "build");
app.use("/admin", express.static(adminBuildPath));

// ==================== API ENDPOINTS ====================
app.use("/api", apiRoutes);
// Health check
// app.get("/api/health", (req, res) => {
//   res.json({
//     success: true,
//     message: "Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚",
//     timestamp: new Date().toISOString(),
//     version: "2.0.0",
//     features: ["file-system-storage", "uuid-filenames"],
//   });
// });

// ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ worker'Ð¾Ð²
app.get("/api/admin/workers-stats", async (req, res) => {
  if (
    process.env.NODE_ENV !== "development" &&
    req.headers["x-admin-key"] !== process.env.ADMIN_KEY
  ) {
    return res.status(403).json({ success: false, message: "Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½" });
  }

  res.json({
    success: true,
    workers: workerService.getStats(),
    memory: process.memoryUsage(),
    uptime: process.uptime(),
  });
});

// Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ - Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°
app.post("/api/auth/forgot-password", async (req, res) => {
  console.log("ðŸ“§ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ");

  // Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÑÐ¿ÐµÑ…Ð°)
  const SECURITY_SUCCESS_MESSAGE =
    "Ð•ÑÐ»Ð¸ email Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ, Ð½Ð° Ð½ÐµÐ³Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ";

  // URL ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ‚ÐµÑ…Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
  const SUPPORT_URL = "https://Ð²Ð°Ñˆ-ÑÐ°Ð¹Ñ‚.com/support"; // â† ÐÐÐ¡Ð¢Ð ÐžÐ™Ð¢Ð• Ð­Ð¢ÐžÐ¢ URL

  try {
    const { email, secretWord } = req.body;
    console.log("ðŸ“§ Email Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:", email);
    console.log(
      "ðŸ” Secret word Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:",
      secretWord ? "Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" : "Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
    );

    // 1. Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ email
    if (!email) {
      console.log("âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ email");
      return res.status(400).json({
        success: false,
        message: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð°Ð´Ñ€ÐµÑ",
        field: "email",
      });
    }

    if (!validator.isEmail(email)) {
      console.log("âŒ ÐÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹ email:", email);
      return res.status(400).json({
        success: false,
        message: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ email Ð°Ð´Ñ€ÐµÑ",
        field: "email",
      });
    }

    const normalizedEmail = email.toLowerCase().trim();

    // 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°
    if (!secretWord) {
      console.log("âŒ ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾");
      return res.status(400).json({
        success: false,
        message: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾",
        field: "secretWord",
      });
    }

    if (typeof secretWord !== "string") {
      console.log("âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°");
      return res.status(400).json({
        success: false,
        message: "ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼",
        field: "secretWord",
      });
    }

    const trimmedSecretWord = secretWord.trim();

    if (trimmedSecretWord === "") {
      console.log("âŒ ÐŸÑƒÑÑ‚Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾");
      return res.status(400).json({
        success: false,
        message: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾",
        field: "secretWord",
      });
    }

    // 3. Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ timing-Ð°Ñ‚Ð°Ðº
    await new Promise((resolve) => setTimeout(resolve, 1000));

    // 4. Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐŸÐ•Ð Ð’Ð«Ðœ Ð”Ð•Ð›ÐžÐœ
    console.log(`ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ email: ${normalizedEmail}`);

    const userResult = await query(
      "SELECT login, email, secret_word, blocked FROM usersdata WHERE email = ? AND logic = 'true'",
      [normalizedEmail]
    );

    // 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    let user = null;

    if (userResult) {
      if (Array.isArray(userResult) && userResult.length > 0) {
        user = userResult[0];
        console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½ (Ð¼Ð°ÑÑÐ¸Ð²):", user.login);
      } else if (userResult.login !== undefined) {
        user = userResult;
        console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½ (Ð¾Ð±ÑŠÐµÐºÑ‚):", user.login);
      } else if (userResult[0] && userResult[0].login !== undefined) {
        user = userResult[0];
        console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½ (Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¹ Ð¼Ð°ÑÑÐ¸Ð²):", user.login);
      } else {
        console.log("âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…");
      }
    }

    // 6. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½)
    let attemptCount = 0;
    let attemptsRecordId = null;

    if (user) {
      try {
        const attemptsResult = await query(
          "SELECT id, attempts FROM password_reset_attempts WHERE email = ?",
          [normalizedEmail]
        );

        if (attemptsResult) {
          if (Array.isArray(attemptsResult) && attemptsResult.length > 0) {
            attemptCount = attemptsResult[0].attempts || 0;
            attemptsRecordId = attemptsResult[0].id;
          } else if (attemptsResult.attempts !== undefined) {
            attemptCount = attemptsResult.attempts || 0;
            attemptsRecordId = attemptsResult.id;
          } else if (
            attemptsResult[0] &&
            attemptsResult[0].attempts !== undefined
          ) {
            attemptCount = attemptsResult[0].attempts || 0;
            attemptsRecordId = attemptsResult[0].id;
          }
        }

        console.log(
          `ðŸ“Š Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð´Ð»Ñ ${normalizedEmail}: ${attemptCount}`
        );
      } catch (attemptsError) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº:", attemptsError.message);
      }
    }

    // 7. Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐÐ•Ð¢ - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
    if (!user) {
      console.log(`ðŸ“­ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: ${normalizedEmail}`);
      return res.status(404).json({
        success: false,
        message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ email Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
        field: "email",
      });
    }

    console.log("ðŸ‘¤ Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:", {
      login: user.login,
      email: user.email,
      hasSecretWord: !!user.secret_word,
      blocked: user.blocked,
    });

    // 8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
    if (user.blocked === 1) {
      console.log(`â›” Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${normalizedEmail}`);
      return res.status(403).json({
        success: false,
        message: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
      });
    }

    // 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚ (3 ÐÐ•Ð£Ð”ÐÐ§ÐÐ«Ð• Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸)
    if (attemptCount >= 3) {
      console.log(
        `ðŸ”’ Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${normalizedEmail} (3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸)`
      );

      try {
        // Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        await query(
          `UPDATE usersdata 
           SET blocked = 1, blocked_until = '2099-12-31 23:59:59'
           WHERE email = ? AND logic = 'true'`,
          [normalizedEmail]
        );

        console.log(
          `âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${normalizedEmail} Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð·Ð° 3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸`
        );

        // ÐžÐ¢ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ EMAIL Ðž Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ•
        try {
          await emailService.sendAccountBlocked({
            login: user.login,
            email: user.email,
            reason: "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ",
            supportUrl: config.SUPPORT_URL,
            ipAddress: req.ip || "unknown",
            userAgent: req.headers["user-agent"] || "",
          });
          console.log(`ðŸ“§ ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: ${user.email}`);
        } catch (emailError) {
          console.error(
            "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ email Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:",
            emailError.message
          );
          // ÐÐµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ email Ð½Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑÑ
        }
      } catch (blockError) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸:", blockError.message);
      }

      return res.status(403).json({
        success: false,
        message:
          "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº. ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
      });
    }

    // 10. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾
    console.log(`ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ ${normalizedEmail}`);
    console.log(
      `ðŸ“ Ð¥ÑÑˆ Ð² Ð‘Ð”: ${user.secret_word ? "Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" : "Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"}`
    );

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° Ð² Ð‘Ð”
    if (!user.secret_word || user.secret_word.trim() === "") {
      console.log(
        `âŒ ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${normalizedEmail}`
      );

      // Ð¤Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ
      try {
        if (attemptsRecordId) {
          await query(
            "UPDATE password_reset_attempts SET attempts = attempts + 1, last_attempt = NOW() WHERE id = ?",
            [attemptsRecordId]
          );
        } else {
          await query(
            `INSERT INTO password_reset_attempts (email, attempts, last_attempt, ip_address, user_agent)
             VALUES (?, 1, NOW(), ?, ?)`,
            [
              normalizedEmail,
              req.ip || "unknown",
              req.headers["user-agent"] || "",
            ]
          );
        }
      } catch (updateError) {
        console.warn(
          "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ:",
          updateError.message
        );
      }

      return res.status(400).json({
        success: false,
        message:
          "Ð”Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð° Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
        field: "secretWord",
      });
    }

    // 11. Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ñ Ñ…ÑÑˆÐµÐ¼
    console.log(`ðŸ” Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° Ñ Ñ…ÑÑˆÐµÐ¼...`);
    const isValidSecretWord = await bcrypt.compare(
      trimmedSecretWord,
      user.secret_word
    );

    console.log(
      `âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ: ${isValidSecretWord ? "Ð’Ð•Ð ÐÐž" : "ÐÐ•Ð’Ð•Ð ÐÐž"}`
    );

    if (!isValidSecretWord) {
      console.log(`âŒ ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð´Ð»Ñ ${normalizedEmail}`);

      // Ð¤Ð˜ÐšÐ¡Ð˜Ð Ð£Ð•Ðœ ÐÐ•Ð£Ð”ÐÐ§ÐÐ£Ð® ÐŸÐžÐŸÐ«Ð¢ÐšÐ£
      try {
        let newAttemptCount = attemptCount + 1;

        if (attemptsRecordId) {
          await query(
            "UPDATE password_reset_attempts SET attempts = attempts + 1, last_attempt = NOW() WHERE id = ?",
            [attemptsRecordId]
          );
        } else {
          await query(
            `INSERT INTO password_reset_attempts (email, attempts, last_attempt, ip_address, user_agent)
             VALUES (?, 1, NOW(), ?, ?)`,
            [
              normalizedEmail,
              req.ip || "unknown",
              req.headers["user-agent"] || "",
            ]
          );
          newAttemptCount = 1;
        }

        console.log(
          `ðŸ“ˆ ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð°: ${newAttemptCount}/3 (Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾)`
        );

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð¸ Ð»Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°
        if (newAttemptCount >= 3) {
          console.log(`ðŸ”’ Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº - Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ°`);

          try {
            // Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            await query(
              `UPDATE usersdata 
               SET blocked = 1, blocked_until = '2099-12-31 23:59:59'
               WHERE email = ? AND logic = 'true'`,
              [normalizedEmail]
            );

            console.log(`âœ… ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ${normalizedEmail} Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½`);

            // ÐžÐ¢ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ EMAIL Ðž Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ•
            try {
              await emailService.sendAccountBlocked({
                login: user.login,
                email: user.email,
                reason: "3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ",
                supportUrl: config.SUPPORT_URL,
                ipAddress: req.ip || "unknown",
                userAgent: req.headers["user-agent"] || "",
              });
              console.log(
                `ðŸ“§ ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: ${user.email}`
              );
            } catch (emailError) {
              console.error(
                "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ email Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:",
                emailError.message
              );
            }
          } catch (blockError) {
            console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:", blockError.message);
          }

          return res.status(403).json({
            success: false,
            message:
              "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº. ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
          });
        }
      } catch (updateError) {
        console.warn(
          "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½ÑƒÑŽ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ:",
          updateError.message
        );
      }

      const remainingAttempts = 3 - (attemptCount + 1);

      let message = "ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾";
      if (remainingAttempts > 0) {
        message += `. ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº: ${remainingAttempts}`;
      }

      return res.status(400).json({
        success: false,
        message: message,
        field: "secretWord",
      });
    }

    // 12. Ð•ÑÐ»Ð¸ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð’Ð•Ð ÐÐž - ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
    console.log(`âœ… ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð²ÐµÑ€Ð½Ð¾ Ð´Ð»Ñ ${normalizedEmail}`);

    try {
      if (attemptsRecordId) {
        await query("DELETE FROM password_reset_attempts WHERE id = ?", [
          attemptsRecordId,
        ]);
        console.log(`ðŸ”„ Ð’ÑÐµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ ${normalizedEmail}`);
      } else {
        await query("DELETE FROM password_reset_attempts WHERE email = ?", [
          normalizedEmail,
        ]);
        console.log(
          `ðŸ”„ Ð’ÑÐµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð¿Ð¾ email: ${normalizedEmail}`
        );
      }
    } catch (deleteError) {
      console.warn("âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸:", deleteError.message);
    }

    // 13. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ email
    console.log(`ðŸ”‘ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð´Ð»Ñ ${normalizedEmail}`);

    try {
      const resetToken = await passwordResetService.createToken(user.email);
      console.log(`âœ… Ð¢Ð¾ÐºÐµÐ½ ÑÐ¾Ð·Ð´Ð°Ð½: ${resetToken?.substring(0, 20)}...`);

      await emailService.sendPasswordReset({
        login: user.login,
        email: user.email,
        resetToken: resetToken,
      });

      console.log(`ðŸ“§ ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: ${user.email}`);
    } catch (serviceError) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:", serviceError.message);
    }

    // 14. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑ…
    console.log(`âœ… Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð»Ñ ${normalizedEmail}`);

    res.status(200).json({
      success: true,
      message: SECURITY_SUCCESS_MESSAGE,
    });
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ:", error);
    console.error("ðŸ“‹ Stack trace:", error.stack);

    res.status(500).json({
      success: false,
      message: "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
    });
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
app.get("/api/auth/validate-reset-token/:token", async (req, res) => {
  try {
    const { token } = req.params;

    if (!token || token.length < 10) {
      return res.status(400).json({
        success: false,
        valid: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½",
      });
    }

    const validation = await passwordResetService.validateToken(token);

    res.json({
      success: true,
      valid: validation.valid,
      email: validation.valid ? validation.email : undefined,
      message: validation.message,
      expiresAt: validation.valid ? validation.expiresAt : undefined,
    });
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:", error);
    res.status(500).json({
      success: false,
      valid: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ð°",
    });
  }
});

// Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ
app.post("/api/auth/reset-password", async (req, res) => {
  try {
    const { token, newPassword } = req.body;

    if (!token || !newPassword) {
      return res.status(400).json({
        success: false,
        message: "Ð¢Ð¾ÐºÐµÐ½ Ð¸ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹",
        field: !token ? "token" : "newPassword",
      });
    }

    try {
      validatePassword(newPassword);
    } catch (validationError) {
      return res.status(400).json({
        success: false,
        message: validationError.message,
        field: "newPassword",
      });
    }

    const validation = await passwordResetService.validateToken(token);

    if (!validation.valid) {
      return res.status(400).json({
        success: false,
        message: validation.message || "Ð¢Ð¾ÐºÐµÐ½ Ð½ÐµÐ´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ½ Ð¸Ð»Ð¸ ÑƒÑÑ‚Ð°Ñ€ÐµÐ»",
      });
    }

    const { email, resetId } = validation;

    const users = await query(
      "SELECT login, password FROM usersdata WHERE email = ? AND logic = 'true'",
      [email]
    );

    if (users.length === 0) {
      return res.status(404).json({
        success: false,
        message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
      });
    }

    const user = users[0];
    const samePassword = await bcrypt.compare(newPassword, user.password);
    if (samePassword) {
      return res.status(400).json({
        success: false,
        message: "ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾",
        field: "newPassword",
      });
    }

    const salt = await bcrypt.genSalt(12);
    const hashedPassword = await bcrypt.hash(newPassword, salt);

    await query(
      "UPDATE usersdata SET password = ? WHERE email = ? AND logic = 'true'",
      [hashedPassword, email]
    );

    await passwordResetService.markAsUsed(resetId);
    await query("DELETE FROM sessionsdata WHERE login = ?", [user.login]);

    try {
      await emailService.sendPasswordChanged({
        login: user.login,
        email: email,
        userIp: req.ip || req.connection.remoteAddress,
        userAgent: req.headers["user-agent"] || "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾",
      });
      console.log(`ðŸ“§ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð° ${email}`);
    } catch (emailError) {
      console.warn(
        "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ email ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ:",
        emailError.message
      );
    }

    console.log(`âœ… ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${user.login}`);

    res.json({
      success: true,
      message:
        "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ð¾Ð¹Ñ‚Ð¸ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼.",
      requireReauth: true,
      emailSent: true,
    });
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ:", error);

    if (error.name === "ValidationError") {
      return res.status(400).json({
        success: false,
        message: error.message,
        field: error.field,
      });
    }

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
    });
  }
});

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° JWT
app.post("/api/auth/verify", authenticateToken, (req, res) => {
  res.json({
    success: true,
    user: {
      login: req.user.login,
      sessionId: req.user.sessionId,
    },
  });
});

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
app.post("/api/auth/register", async (req, res) => {
  try {
    // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ‚Ð¾Ñ€Ñ‹)
    const login = validateLogin(req.body.login);
    const password = validatePassword(req.body.password);
    const email = validateEmail(req.body.email);
    const secretWord = validateSecretWord(req.body.secretWord); // â† ÐÐžÐ’ÐžÐ•: Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð¼Ð¸Ñ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð½Ð° email
    const emailUsage = await query(
      "SELECT COUNT(*) as count FROM usersdata WHERE email = ?",
      [email]
    );

    const userCount = emailUsage[0].count || 0;

    if (userCount >= MAX_USERS_PER_EMAIL) {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      const updatedEmailUsage = await query(
        "SELECT COUNT(*) as count FROM usersdata WHERE email = ? AND logic = 'true'",
        [email]
      );

      const activeUserCount = updatedEmailUsage[0].count || 0;

      if (activeUserCount >= MAX_USERS_PER_EMAIL) {
        return res.status(400).json({
          success: false,
          message: `ÐÐ° ÑÑ‚Ð¾Ñ‚ email ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (${MAX_USERS_PER_EMAIL}). Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ñ‹ Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ email.`,
          field: "email",
        });
      }
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð»Ð¾Ð³Ð¸Ð½Ð°
    const existingLogin = await query(
      "SELECT login FROM usersdata WHERE login = ?",
      [login]
    );

    if (existingLogin.length > 0) {
      throw new ValidationError("Ð›Ð¾Ð³Ð¸Ð½ ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚", "login");
    }

    // Ð¥ÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ
    const salt = await bcrypt.genSalt(12);
    const hashedPassword = await bcrypt.hash(password, salt);

    // Ð¥ÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ð°ÐºÑƒÑŽ Ð¶Ðµ ÑÐ¾Ð»ÑŒ ÐºÐ°Ðº Ð´Ð»Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ)
    const hashedSecretWord = await bcrypt.hash(secretWord, salt);

    // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
    const confirmToken = jwt.sign(
      { login, email, purpose: "registration" },
      JWT_SECRET,
      { expiresIn: "24h" }
    );

    // Ð’ÑÑ‚Ð°Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð‘Ð” Ñ ÐºÐ¾Ð´Ð¾Ð²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼
    await query(
      `INSERT INTO usersdata (login, password, email, jwt, logic, secret_word) 
       VALUES (?, ?, ?, ?, ?, ?)`,
      [login, hashedPassword, email, confirmToken, "false", hashedSecretWord]
    );

    // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼
    const updatedCount = await query(
      "SELECT COUNT(*) as count FROM usersdata WHERE email = ? AND logic = 'true'",
      [email]
    );

    const activeUserCount = updatedCount[0].count || 0;

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° email Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
    await emailService.sendRegistrationConfirm({
      login: login,
      email: email,
      activeUserCount: activeUserCount,
      maxUsers: MAX_USERS_PER_EMAIL,
      confirmToken: confirmToken,
    });

    // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
    console.log(`âœ… ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½: ${login} (${email})`);

    res.json({
      success: true,
      message: `Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°. ÐÐ° ÑÑ‚Ð¾Ñ‚ email Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ ${activeUserCount}/${MAX_USERS_PER_EMAIL} Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ email Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.`,
      stats: {
        currentUsers: activeUserCount,
        maxUsers: MAX_USERS_PER_EMAIL,
        remainingSlots: MAX_USERS_PER_EMAIL - activeUserCount,
      },
    });
  } catch (error) {
    console.error("Registration error:", error);

    if (error.name === "ValidationError") {
      return res.status(400).json({
        success: false,
        message: error.message,
        field: error.field,
      });
    }

    // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    console.error("ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:", {
      message: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString(),
    });

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
    });
  }
});

// ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ email
app.get("/api/auth/confirm/:token", async (req, res) => {
  try {
    const { token } = req.params;
    const decoded = jwt.verify(token, JWT_SECRET);

    if (decoded.purpose !== "registration") {
      return res.send(HTML_TEMPLATES.ERROR_INVALID_TOKEN);
    }

    const result = await query(
      "UPDATE usersdata SET logic = 'true' WHERE login = ? AND email = ? AND logic = 'false'",
      [decoded.login, decoded.email]
    );

    if (result.affectedRows === 0) {
      return res.send(HTML_TEMPLATES.ERROR_USER_NOT_FOUND);
    }

    await userTableService.createUserTable(decoded.login);

    res.send(HTML_TEMPLATES.SUCCESS_CONFIRMED);
  } catch (error) {
    if (
      error.name === "JsonWebTokenError" ||
      error.name === "TokenExpiredError"
    ) {
      return res.send(HTML_TEMPLATES.ERROR_EXPIRED_TOKEN);
    }

    console.error("Confirm email error:", error);
    res.send(HTML_TEMPLATES.ERROR_SERVER);
  }
});

// Ð’Ñ…Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.post("/api/auth/login", async (req, res) => {
  try {
    const login = validateLogin(req.body.login);
    const password = validatePassword(req.body.password);

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ IP Ð¸ User-Agent Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
    const userIp = req.ip || req.connection.remoteAddress;
    const userAgent = req.headers["user-agent"] || "Unknown";

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð’ÐœÐ•Ð¡Ð¢Ð• Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸
    const users = await query(
      "SELECT *, blocked, blocked_until FROM usersdata WHERE login = ?",
      [login]
    );

    if (users.length === 0) {
      // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐÐ•Ð£Ð”ÐÐ§ÐÐžÐ™ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
      // await query(
      //   "INSERT INTO login_attempts (login, ip_address, success, user_agent) VALUES (?, ?, ?, ?)",
      //   [login, userIp, 0, userAgent]
      // );

      await new Promise((resolve) => setTimeout(resolve, 1000));
      return res.status(401).json({
        success: false,
        message: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ",
      });
    }

    const user = users[0];

    // ========== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ˜ ==========
    if (user.blocked === 1 && user.blocked_until) {
      const now = new Date();
      const blockUntil = new Date(user.blocked_until);

      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð¸ÑÑ‚Ñ‘Ðº Ð»Ð¸ ÑÑ€Ð¾Ðº Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸
      if (blockUntil > now) {
        // Ð’ÑÑ‘ ÐµÑ‰Ñ‘ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½
        let message = "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½";

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð±ÐµÑÑÑ€Ð¾Ñ‡Ð½ÑƒÑŽ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÑƒ (2099 Ð³Ð¾Ð´)
        if (blockUntil.getFullYear() >= 2099) {
          message += " Ð±ÐµÑÑÑ€Ð¾Ñ‡Ð½Ð¾.";
        } else {
          // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð² Ñ€ÑƒÑÑÐºÐ¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ (Ð´ÐµÐ½ÑŒ Ð¼ÐµÑÑÑ† Ð³Ð¾Ð´)
          const day = blockUntil.getDate();
          const month = blockUntil.toLocaleString("ru-RU", { month: "long" });
          const year = blockUntil.getFullYear();
          message += ` Ð´Ð¾ ${day} ${month} ${year} Ð³Ð¾Ð´Ð°.`;
        }

        // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ Ð²Ñ…Ð¾Ð´Ð° Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        // Ð’ ÐÐžÐ’Ð£Ð® Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ blocked_login_attempts
        await query(
          `INSERT INTO blocked_login_attempts 
           (user_login, ip_address, user_agent, blocked_until) 
           VALUES (?, ?, ?, ?)`,
          [login, userIp, userAgent, user.blocked_until]
        );

        // Ð§Ð˜Ð¡Ð¢Ð«Ð™ Ð¾Ñ‚Ð²ÐµÑ‚ Ð±ÐµÐ· Ð´Ð¾Ð¿ Ð¿Ð¾Ð»ÐµÐ¹
        return res.status(403).json({
          success: false,
          message: message,
        });
      } else {
        // Ð¡Ñ€Ð¾Ðº Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸ÑÑ‚Ñ‘Ðº â†’ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ°
        console.log(`ðŸ”„ ÐÐ²Ñ‚Ð¾Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${login}, ÑÑ€Ð¾Ðº Ð¸ÑÑ‚Ñ‘Ðº`);

        // Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        await query(
          "UPDATE usersdata SET blocked = 0, blocked_until = NULL WHERE login = ?",
          [login]
        );

        // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÑƒ
        // 1. Ð’ blocked_login_attempts Ð¿Ð¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ ÐºÐ°Ðº auto_unblocked
        await query(
          `UPDATE blocked_login_attempts 
           SET auto_unblocked = TRUE, unblocked_at = NOW()
           WHERE user_login = ? 
           AND auto_unblocked = FALSE
           AND unblocked_at IS NULL
           ORDER BY attempted_at DESC LIMIT 1`,
          [login]
        );

        // 2. Ð˜ Ð² admin_logs Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð°ÑƒÐ´Ð¸Ñ‚Ð°
        // await query(
        //   `INSERT INTO admin_logs (admin_id, action_type, target_type, target_id, details)
        //    VALUES (?, ?, ?, ?, ?)`,
        //   [
        //     0, // system
        //     "auto_unblock",
        //     "user",
        //     login,
        //     JSON.stringify({
        //       original_block_until: user.blocked_until,
        //       reason: "block_expired",
        //       auto_unblocked: true,
        //     }),
        //   ]
        // );

        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        user.blocked = 0;
        user.blocked_until = null;
      }
    }
    // ========== ÐšÐžÐÐ•Ð¦ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ˜ Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ˜ ==========

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð° (logic Ð¿Ð¾Ð»Ðµ)
    if (user.logic !== "true") {
      // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐÐ•Ð£Ð”ÐÐ§ÐÐžÐ™ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ - Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½
      // await query(
      //   "INSERT INTO login_attempts (login, ip_address, success, user_agent) VALUES (?, ?, ?, ?)",
      //   [login, userIp, 0, userAgent]
      // );

      return res.status(403).json({
        success: false,
        message: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ email Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.",
      });
    }

    const validPassword = await bcrypt.compare(password, user.password);
    if (!validPassword) {
      // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐÐ•Ð£Ð”ÐÐ§ÐÐžÐ™ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ - Ð½ÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
      // await query(
      //   "INSERT INTO login_attempts (login, ip_address, success, user_agent) VALUES (?, ?, ?, ?)",
      //   [login, userIp, 0, userAgent]
      // );

      await new Promise((resolve) => setTimeout(resolve, 1000));
      return res.status(401).json({
        success: false,
        message: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ",
      });
    }

    // Ð£Ð¡ÐŸÐ•Ð¨ÐÐ«Ð™ Ð’Ð¥ÐžÐ”
    // Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð£Ð¡ÐŸÐ•Ð¨ÐÐžÐ™ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð°
    // await query(
    //   "INSERT INTO login_attempts (login, ip_address, success, user_agent) VALUES (?, ?, ?, ?)",
    //   [login, userIp, 1, userAgent]
    // );

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð²Ñ…Ð¾Ð´
    await query("UPDATE usersdata SET last_login = NOW() WHERE login = ?", [
      login,
    ]);

    // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
    const sessionToken = jwt.sign({ login: user.login }, JWT_SECRET_TWO, {
      expiresIn: "2h",
    });

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ
    await query("INSERT INTO sessionsdata (login, jwt_access) VALUES (?, ?)", [
      user.login,
      sessionToken,
    ]);

    // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐµÑÑÐ¸Ð¹ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5)
    await query(
      `DELETE FROM sessionsdata 
       WHERE login = ? AND id NOT IN (
         SELECT id FROM (
           SELECT id FROM sessionsdata 
           WHERE login = ? 
           ORDER BY date DESC 
           LIMIT 5
         ) AS latest
       )`,
      [user.login, user.login]
    );

    // Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
    res.json({
      success: true,
      token: sessionToken,
      user: {
        login: user.login,
        email: user.email,
      },
    });
  } catch (error) {
    if (error.name === "ValidationError") {
      return res.status(400).json({
        success: false,
        message: error.message,
        field: error.field,
      });
    }

    console.error("Login error:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
    });
  }
});

// Ð’Ñ‹Ñ…Ð¾Ð´
app.post("/api/auth/logout", authenticateToken, async (req, res) => {
  try {
    await query("DELETE FROM sessionsdata WHERE jwt_access = ?", [
      req.user.token,
    ]);

    res.json({
      success: true,
      message: "Ð’Ñ‹Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾",
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ñ…Ð¾Ð´Ð°",
    });
  }
});

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¾Ð¿Ñ€Ð¾ÑÐ°
app.post("/api/surveys/save", authenticateToken, async (req, res) => {
  try {
    const survey = validateSurvey(req.body.survey);
    const login = req.user.login;

    if (!survey) {
      return res.status(400).json({
        success: false,
        message: "Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð¿Ñ€Ð¾ÑÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚",
      });
    }

    const tableExists = await userTableService.tableExists(login);
    if (!tableExists) {
      await userTableService.createUserTable(login);
    }

    await query(
      `INSERT INTO \`${login}\` (survey, type) VALUES (?, 'survey')`,
      [JSON.stringify(survey)]
    );

    res.json({
      success: true,
      message: "ÐžÐ¿Ñ€Ð¾Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾",
    });
  } catch (error) {
    console.error("Save survey error:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€Ð¾ÑÐ°",
    });
  }
});

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
app.post(
  "/api/images/upload",
  authenticateToken,
  uploadSingleImage,
  async (req, res) => {
    const login = req.user.login;
    const startTime = Date.now();
    let fileUuid = "";
    try {
      console.log(`ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¾Ñ‚ ${login}`, {
        filename: req.file?.originalname,
        size: (req.file?.size / 1024 / 1024).toFixed(2) + " MB",
      });

      if (!req.file) {
        return res.status(400).json({
          success: false,
          message: "Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð¸Ð»Ð¸ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ñ€Ð°Ð·Ð¼ÐµÑ€ (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 15MB)",
          field: "file",
        });
      }

      const { filename, comment } = req.body;
      const file = req.file;

      const validated = validateImageBuffer(
        file.buffer,
        filename || file.originalname
      );

      const tableExists = await userTableService.tableExists(login);

      if (!tableExists) {
        await userTableService.createUserTable(login);
      }

      fileUuid = crypto.randomUUID();

      console.log(`ðŸ”„ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² Ð²Ð¾Ñ€ÐºÐµÑ€: ${fileUuid}`);

      const workerResult = await workerService.addTask({
        buffer: file.buffer,
        originalFilename: validated.filename,
        userDir: path.join(UPLOAD_DIR, login),
        fileUuid,
      });

      const workerTime = Date.now() - startTime;

      if (!workerResult.success) {
        throw new Error(`Worker Ð¾ÑˆÐ¸Ð±ÐºÐ°: ${workerResult.error}`);
      }

      console.log(
        `âœ… Worker Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð·Ð° ${workerTime}ms:`,
        workerResult.filename
      );

      await query(
        `INSERT INTO \`${login}\` (
        file_uuid, fileNameOriginIMG, file_path, thumbnail_path, 
        comment, file_size, mime_type, 
        file_hash, width, height, type
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          fileUuid,
          workerResult.originalFilename,
          workerResult.filename,
          workerResult.filename,
          comment || "",
          workerResult.fileSize,
          workerResult.mimeType,
          workerResult.fileHash,
          workerResult.width,
          workerResult.height,
          "image",
        ]
      );

      const totalTime = Date.now() - startTime;

      console.log(`âœ… Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ Ð·Ð° ${totalTime}ms`);
      console.log(`ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð²Ð¾Ñ€ÐºÐµÑ€Ð¾Ð²:`, workerService.getStats());

      res.json({
        success: true,
        message: "Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾",
        fileUuid,
        filename: workerResult.filename,
        thumbnailUrl: `/uploads/${login}/thumbnails/${workerResult.filename}`,
        originalUrl: `/uploads/${login}/originals/${workerResult.filename}`,
        dimensions: {
          width: workerResult.width,
          height: workerResult.height,
        },
        processingStats: {
          workerTime: `${workerTime}ms`,
          totalTime: `${totalTime}ms`,
          fallbackUsed: workerResult.fallback || false,
        },
      });
    } catch (error) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:", error);

      if (req.file && login) {
        try {
          const userDir = path.join(UPLOAD_DIR, login);
          const filesToDelete = await fs.readdir(userDir).catch(() => []);

          for (const file of filesToDelete) {
            if (file.includes(fileUuid)) {
              await fs.unlink(path.join(userDir, file)).catch(() => {});
            }
          }
        } catch (cleanupError) {
          console.warn("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸:", cleanupError.message);
        }
      }

      if (error.name === "ValidationError") {
        return res.status(400).json({
          success: false,
          message: error.message,
          field: error.field,
        });
      }

      res.status(500).json({
        success: false,
        message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.",
        technical:
          process.env.NODE_ENV === "development" ? error.message : undefined,
      });
    }
  }
);

// ÐŸÐ¾Ð¸ÑÐº Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·Ð¾Ð²
app.post("/api/diagnoses/search", async (req, res) => {
  try {
    const { titles } = req.body;

    if (!titles || !Array.isArray(titles) || titles.length === 0) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°",
      });
    }

    const validatedTitles = titles.map((title) => {
      if (typeof title !== "string" || title.length > 100) {
        throw new ValidationError("ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð´Ð¸Ð°Ð³Ð½Ð¾Ð· Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°", "titles");
      }
      return title.trim();
    });

    const placeholders = validatedTitles.map(() => "?").join(",");
    const sql = `SELECT * FROM alldiagnoses WHERE nameOfDisease IN (${placeholders})`;

    const results = await query(sql, validatedTitles);

    const diagnoses = [];
    const diagnosticsSet = new Set();
    const treatmentsSet = new Set();

    results.forEach((row) => {
      diagnoses.push(row.nameofDiseaseRu);

      if (row.diagnostics) {
        row.diagnostics.split(",").forEach((d) => {
          const trimmed = d.trim();
          if (trimmed) diagnosticsSet.add(trimmed);
        });
      }

      if (row.treatment) {
        row.treatment.split(",").forEach((t) => {
          const trimmed = t.trim();
          if (trimmed) treatmentsSet.add(trimmed);
        });
      }
    });

    res.json({
      success: true,
      titles: [...new Set(diagnoses)],
      diagnostic: Array.from(diagnosticsSet),
      treatment: Array.from(treatmentsSet),
    });
  } catch (error) {
    if (error.name === "ValidationError") {
      return res.status(400).json({
        success: false,
        message: error.message,
      });
    }

    console.error("Search diagnoses error:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ° Ð´Ð¸Ð°Ð³Ð½Ð¾Ð·Ð¾Ð²",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹
app.post("/api/surveys/paginated", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;
    const { page = 1, limit = 5 } = req.body;

    const pageNum = parseInt(page);
    const limitNum = parseInt(limit);

    if (isNaN(pageNum) || pageNum < 1) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹",
      });
    }

    if (isNaN(limitNum) || limitNum < 1 || limitNum > 50) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 50 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ)",
      });
    }

    const offset = (pageNum - 1) * limitNum;

    const tableExists = await userTableService.tableExists(login);

    if (!tableExists) {
      return res.json({
        success: true,
        surveys: [],
        pagination: {
          currentPage: pageNum,
          totalPages: 0,
          totalItems: 0,
          itemsPerPage: limitNum,
          hasNextPage: false,
          hasPrevPage: false,
        },
      });
    }

    const countResult = await query(
      `SELECT COUNT(*) as total FROM \`${login}\` WHERE survey IS NOT NULL`
    );
    const totalItems = countResult[0].total || 0;
    const totalPages = Math.ceil(totalItems / limitNum);

    const sqlQuery = `
      SELECT id, survey, created_at FROM \`${login}\` 
      WHERE survey IS NOT NULL 
      ORDER BY created_at DESC, id DESC 
      LIMIT ${limitNum} OFFSET ${offset}
    `;

    const surveys = await query(sqlQuery);

    const parsedSurveys = surveys.map((row) => {
      try {
        const surveyData = JSON.parse(row.survey);
        return {
          id: row.id,
          date: row.created_at,
          survey: surveyData,
        };
      } catch {
        return {
          id: row.id,
          date: row.created_at,
          survey: { date: row.created_at },
        };
      }
    });

    res.json({
      success: true,
      surveys: parsedSurveys,
      pagination: {
        currentPage: pageNum,
        totalPages: totalPages,
        totalItems: totalItems,
        itemsPerPage: limitNum,
        hasNextPage: pageNum < totalPages,
        hasPrevPage: pageNum > 1,
      },
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹:", error);

    if (error.code === "ER_NO_SUCH_TABLE") {
      return res.json({
        success: true,
        surveys: [],
        pagination: {
          currentPage: 1,
          totalPages: 0,
          totalItems: 0,
          itemsPerPage: parseInt(req.body.limit) || 5,
          hasNextPage: false,
          hasPrevPage: false,
        },
      });
    }

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¾Ð¿Ñ€Ð¾ÑÐ°
app.get("/api/surveys/:id", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;
    const { id } = req.params;

    if (!id || isNaN(parseInt(id))) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ID",
      });
    }

    const sql = `SELECT survey FROM \`${login}\` WHERE id = ? AND survey IS NOT NULL`;
    const results = await query(sql, [parseInt(id)]);

    if (results.length === 0) {
      return res.status(404).json({
        success: false,
        message: "ÐžÐ¿Ñ€Ð¾Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
      });
    }

    res.json({
      success: true,
      survey: JSON.parse(results[0].survey),
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€Ð¾ÑÐ°:", error);

    if (error.code === "ER_NO_SUCH_TABLE") {
      return res.status(404).json({
        success: false,
        message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ñƒ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²",
      });
    }

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ð¿Ñ€Ð¾ÑÐ°",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
app.get("/api/images/original/:uuid", authenticateToken, async (req, res) => {
  const login = req.user.login;
  try {
    const { uuid } = req.params;

    if (!uuid) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ UUID",
      });
    }

    const sql = `SELECT 
      fileNameOriginIMG, 
      file_path,
      file_uuid,
      id
     FROM \`${login}\` WHERE file_uuid = ? AND fileNameOriginIMG IS NOT NULL`;

    const results = await query(sql, [uuid]);

    if (results.length === 0) {
      return res.status(404).json({
        success: false,
        message: "Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾",
      });
    }

    const row = results[0];

    let filename = row.file_path || "";

    if (filename.includes("/") || filename.includes("\\")) {
      filename = path.basename(filename);
    }

    const filePath = path.join(UPLOAD_DIR, login, "originals", filename);

    try {
      await fs.access(filePath);

      return res.json({
        success: true,
        originalUrl: `/uploads/${login}/originals/${filename}`,
        filename: row.fileNameOriginIMG,
        fileUuid: row.file_uuid || uuid,
        id: row.id,
      });
    } catch (fsError) {
      console.error(`âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð° Ð´Ð¸ÑÐºÐµ: ${filePath}`, fsError);

      try {
        const files = await fs.readdir(
          path.join(UPLOAD_DIR, login, "originals")
        );

        const matchingFile = files.find((file) => file.includes(uuid));

        if (matchingFile) {
          return res.json({
            success: true,
            originalUrl: `/uploads/${login}/originals/${matchingFile}`,
            filename: row.fileNameOriginIMG,
            fileUuid: uuid,
          });
        }
      } catch (readError) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:", readError);
      }

      res.status(404).json({
        success: false,
        message: "Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð° Ð´Ð¸ÑÐºÐµ",
      });
    }
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ:", error);

    if (error.code === "ER_NO_SUCH_TABLE") {
      return res.status(404).json({
        success: false,
        message: `Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ '${login}' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°`,
      });
    }

    if (error.code === "ER_PARSE_ERROR") {
      console.error("Ð¡Ð˜ÐÐ¢ÐÐšÐ¡Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ SQL! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ SQL Ð·Ð°Ð¿Ñ€Ð¾Ñ");
    }

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",
      details:
        process.env.NODE_ENV === "development" ? error.message : undefined,
    });
  }
});

// Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
app.delete("/api/data/:id", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;
    const { id } = req.params;

    if (!id || isNaN(parseInt(id))) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ID",
      });
    }

    const fileInfo = await query(
      `SELECT file_uuid, type FROM \`${login}\` WHERE id = ?`,
      [id]
    );

    if (fileInfo.length === 0) {
      return res.status(404).json({
        success: false,
        message: "Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°",
      });
    }

    if (fileInfo[0].type === "image" && fileInfo[0].file_uuid) {
      await deleteImageFromDisk(fileInfo[0].file_uuid, login);
    }

    const result = await query(`DELETE FROM \`${login}\` WHERE id = ?`, [id]);

    if (result.affectedRows === 0) {
      return res.status(404).json({
        success: false,
        message: "Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°",
      });
    }

    res.json({
      success: true,
      message: "Ð—Ð°Ð¿Ð¸ÑÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°",
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹
app.post("/api/images/paginated", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;
    const { page = 1, limit = 5 } = req.body;

    const pageNum = parseInt(page);
    const limitNum = parseInt(limit);

    if (isNaN(pageNum) || pageNum < 1) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹",
      });
    }

    if (isNaN(limitNum) || limitNum < 1 || limitNum > 50) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 50 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ)",
      });
    }

    const offset = (pageNum - 1) * limitNum;

    const tableExists = await userTableService.tableExists(login);

    if (!tableExists) {
      return res.json({
        success: true,
        images: [],
        pagination: {
          currentPage: pageNum,
          totalPages: 0,
          totalItems: 0,
          itemsPerPage: limitNum,
          hasNextPage: false,
          hasPrevPage: false,
        },
      });
    }

    const countResult = await query(
      `SELECT COUNT(*) as total FROM \`${login}\` WHERE fileNameOriginIMG IS NOT NULL`
    );
    const totalItems = countResult[0].total || 0;
    const totalPages = Math.ceil(totalItems / limitNum);

    const sql = `
      SELECT 
        id, 
        file_uuid,
        fileNameOriginIMG, 
        file_path, 
        thumbnail_path,
        comment, 
        file_size,
        width,
        height,
        created_at 
      FROM \`${login}\` 
      WHERE fileNameOriginIMG IS NOT NULL 
      ORDER BY created_at DESC, id DESC 
      LIMIT ${limitNum} OFFSET ${offset}
    `;

    const connection = await getConnection();
    try {
      const [images] = await connection.execute(sql);

      const parsedImages = images.map((row) => {
        let storedFilename = row.file_path || "";
        let thumbnailFilename = row.thumbnail_path || "";

        if (
          storedFilename &&
          (storedFilename.includes("/") || storedFilename.includes("\\"))
        ) {
          storedFilename = storedFilename.replace(/\\/g, "/");
          storedFilename = path.basename(storedFilename);
        }

        if (
          thumbnailFilename &&
          (thumbnailFilename.includes("/") || thumbnailFilename.includes("\\"))
        ) {
          thumbnailFilename = thumbnailFilename.replace(/\\/g, "/");
          thumbnailFilename = path.basename(thumbnailFilename);
        }

        if (!storedFilename && row.file_uuid && row.fileNameOriginIMG) {
          const extension = path.extname(row.fileNameOriginIMG) || ".jpg";
          const baseName = path.basename(row.fileNameOriginIMG, extension);
          const safeBaseName = baseName.replace(
            /[^a-zA-Z0-9Ð°-ÑÐ-Ð¯Ñ‘Ð._-]/g,
            "_"
          );
          storedFilename = `${row.file_uuid}_${safeBaseName}${extension}`;
        }

        if (!thumbnailFilename && storedFilename) {
          thumbnailFilename = storedFilename;
        }

        const originalUrl = storedFilename
          ? `/uploads/${login}/originals/${storedFilename}`
          : null;
        const thumbnailUrl = thumbnailFilename
          ? `/uploads/${login}/thumbnails/${thumbnailFilename}`
          : originalUrl;

        return {
          id: row.id,
          fileUuid: row.file_uuid,
          fileName: row.fileNameOriginIMG || "unknown.jpg",
          storedFilename: storedFilename,
          originalUrl: originalUrl,
          thumbnailUrl: thumbnailUrl,
          comment: row.comment || "",
          fileSize: row.file_size,
          dimensions:
            row.width && row.height ? `${row.width}x${row.height}` : null,
          created_at: row.created_at,
          isFileOnDisk: true,
        };
      });

      res.json({
        success: true,
        images: parsedImages,
        pagination: {
          currentPage: pageNum,
          totalPages: totalPages,
          totalItems: totalItems,
          itemsPerPage: limitNum,
          hasNextPage: pageNum < totalPages,
          hasPrevPage: pageNum > 1,
        },
      });
    } finally {
      connection.release();
    }
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹:", error);

    if (error.code === "ER_NO_SUCH_TABLE") {
      return res.json({
        success: true,
        images: [],
        pagination: {
          currentPage: 1,
          totalPages: 0,
          totalItems: 0,
          itemsPerPage: parseInt(req.body.limit) || 5,
          hasNextPage: false,
          hasPrevPage: false,
        },
        message: "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°",
      });
    }

    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ²ÑŒÑŽ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
app.get("/api/images/thumbnail/:uuid", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;
    const { uuid } = req.params;

    if (!uuid) {
      return res.status(400).json({
        success: false,
        message: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ UUID",
      });
    }

    const results = await query(
      `SELECT thumbnail_path FROM ?? WHERE file_uuid = ?`,
      [login, uuid]
    );

    if (results.length === 0) {
      return res.status(404).json({
        success: false,
        message: "ÐŸÑ€ÐµÐ²ÑŒÑŽ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾",
      });
    }

    const row = results[0];
    const filename = path.basename(row.thumbnail_path);

    return res.json({
      success: true,
      thumbnailUrl: `/uploads/${login}/thumbnails/${filename}`,
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ²ÑŒÑŽ:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ²ÑŒÑŽ",
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
app.get("/api/settings/user-info", authenticateToken, async (req, res) => {
  try {
    const login = req.user.login;

    const userInfo = await query(
      "SELECT login, email FROM usersdata WHERE login = ? AND logic = 'true'",
      [login]
    );

    if (userInfo.length === 0) {
      return res.status(404).json({
        success: false,
        message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
      });
    }

    res.json({
      success: true,
      user: {
        login: userInfo[0].login,
        email: userInfo[0].email,
      },
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:", error);
    res.status(500).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸",
    });
  }
});

// Ð¡Ð¼ÐµÐ½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ Ñ ÐºÐ¾Ð´Ð¾Ð²Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼
app.post(
  "/api/settings/change-password",
  authenticateToken,
  async (req, res) => {
    console.log("ðŸ” Ð—Ð°Ð¿Ñ€Ð¾Ñ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°");

    try {
      const { currentPassword, newPassword, secretWord } = req.body;
      console.log(
        "ðŸ” Secret word Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:",
        secretWord ? "Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" : "Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
      );

      const login = req.user.login;
      console.log("ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:", login);

      // 1. Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
      if (!currentPassword || !newPassword || !secretWord) {
        return res.status(400).json({
          success: false,
          message: !currentPassword
            ? "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
            : !newPassword
            ? "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
            : "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾",
          field: !currentPassword
            ? "currentPassword"
            : !newPassword
            ? "newPassword"
            : "secretWord",
        });
      }

      if (typeof secretWord !== "string") {
        return res.status(400).json({
          success: false,
          message: "ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼",
          field: "secretWord",
        });
      }

      const trimmedSecretWord = secretWord.trim();
      if (trimmedSecretWord === "") {
        return res.status(400).json({
          success: false,
          message: "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾",
          field: "secretWord",
        });
      }

      // 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ
      try {
        validatePassword(newPassword);
      } catch (validationError) {
        return res.status(400).json({
          success: false,
          message: validationError.message,
          field: "newPassword",
        });
      }

      // 3. Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ timing-Ð°Ñ‚Ð°Ðº
      await new Promise((resolve) => setTimeout(resolve, 1000));

      // 4. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      console.log(`ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${login}`);
      const user = await query(
        "SELECT login, email, password, secret_word, blocked FROM usersdata WHERE login = ? AND logic = 'true'",
        [login]
      );

      if (!user || user.length === 0) {
        console.log(`âŒ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: ${login}`);
        return res.status(404).json({
          success: false,
          message: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
        });
      }

      const userData = user[0];
      const userEmail = userData.email;
      console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½:", {
        login: userData.login,
        email: userEmail,
        hasSecretWord: !!userData.secret_word,
        blocked: userData.blocked,
      });

      // 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
      if (userData.blocked === 1) {
        console.log(`â›” Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: ${login}`);
        return res.status(403).json({
          success: false,
          message: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
        });
      }

      // 6. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¿Ð¾ EMAIL
      let attemptCount = 0;
      let attemptsRecordId = null;

      try {
        const attemptsResult = await query(
          "SELECT id, attempts FROM password_reset_attempts WHERE email = ?",
          [userEmail]
        );

        if (attemptsResult && attemptsResult.length > 0) {
          attemptCount = attemptsResult[0].attempts || 0;
          attemptsRecordId = attemptsResult[0].id;
        }

        console.log(
          `ðŸ“Š Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð´Ð»Ñ ${userEmail}: ${attemptCount}`
        );
      } catch (attemptsError) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº:", attemptsError.message);
      }

      // 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚ (3 ÐÐ•Ð£Ð”ÐÐ§ÐÐ«Ð• Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸)
      if (attemptCount >= 3) {
        console.log(
          `ðŸ”’ Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${login} (3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ)`
        );

        try {
          // Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
          await query(
            `UPDATE usersdata 
             SET blocked = 1, blocked_until = '2099-12-31 23:59:59'
             WHERE login = ? AND logic = 'true'`,
            [login]
          );

          console.log(
            `âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${login} Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð·Ð° 3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸`
          );

          // ÐžÐ¢ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ EMAIL Ðž Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ•
          try {
            await emailService.sendAccountBlocked({
              login: userData.login,
              email: userEmail,
              reason: "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ",
              supportUrl: config.SUPPORT_URL,
              ipAddress: req.ip || "unknown",
              userAgent: req.headers["user-agent"] || "",
            });
            console.log(`ðŸ“§ ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: ${userEmail}`);
          } catch (emailError) {
            console.error(
              "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ email Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:",
              emailError.message
            );
          }
        } catch (blockError) {
          console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸:", blockError.message);
        }

        return res.status(401).json({
          success: false,
          message:
            "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº. ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
        });
      }

      // 8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° Ð² Ð‘Ð”
      if (!userData.secret_word || userData.secret_word.trim() === "") {
        console.log(
          `âŒ ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${login}`
        );

        // Ð¤Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ Ð¿Ð¾ EMAIL
        try {
          if (attemptsRecordId) {
            await query(
              "UPDATE password_reset_attempts SET attempts = attempts + 1, last_attempt = NOW() WHERE id = ?",
              [attemptsRecordId]
            );
          } else {
            await query(
              `INSERT INTO password_reset_attempts (email, attempts, last_attempt, ip_address, user_agent)
               VALUES (?, 1, NOW(), ?, ?)`,
              [userEmail, req.ip || "unknown", req.headers["user-agent"] || ""]
            );
          }
        } catch (updateError) {
          console.warn(
            "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ:",
            updateError.message
          );
        }

        return res.status(400).json({
          success: false,
          message:
            "Ð”Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð° Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
          field: "secretWord",
        });
      }

      // 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾
      console.log(`ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ ${login}`);
      const isValidSecretWord = await bcrypt.compare(
        trimmedSecretWord,
        userData.secret_word
      );

      console.log(
        `âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ: ${isValidSecretWord ? "Ð’Ð•Ð ÐÐž" : "ÐÐ•Ð’Ð•Ð ÐÐž"}`
      );

      if (!isValidSecretWord) {
        console.log(`âŒ ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð´Ð»Ñ ${login}`);

        // Ð¤Ð˜ÐšÐ¡Ð˜Ð Ð£Ð•Ðœ ÐÐ•Ð£Ð”ÐÐ§ÐÐ£Ð® ÐŸÐžÐŸÐ«Ð¢ÐšÐ£ Ð¿Ð¾ EMAIL
        try {
          let newAttemptCount = attemptCount + 1;

          if (attemptsRecordId) {
            await query(
              "UPDATE password_reset_attempts SET attempts = attempts + 1, last_attempt = NOW() WHERE id = ?",
              [attemptsRecordId]
            );
          } else {
            await query(
              `INSERT INTO password_reset_attempts (email, attempts, last_attempt, ip_address, user_agent)
               VALUES (?, 1, NOW(), ?, ?)`,
              [userEmail, req.ip || "unknown", req.headers["user-agent"] || ""]
            );
            newAttemptCount = 1;
          }

          console.log(
            `ðŸ“ˆ ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð°: ${newAttemptCount}/3 (Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾)`
          );

          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð¸ Ð»Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð°
          if (newAttemptCount >= 3) {
            console.log(`ðŸ”’ Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½ÑƒÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº - Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ°`);

            try {
              // Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
              await query(
                `UPDATE usersdata 
                 SET blocked = 1, blocked_until = '2099-12-31 23:59:59'
                 WHERE login = ? AND logic = 'true'`,
                [login]
              );

              console.log(`âœ… ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ${login} Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½`);

              // ÐžÐ¢ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ EMAIL Ðž Ð‘Ð›ÐžÐšÐ˜Ð ÐžÐ’ÐšÐ•
              try {
                await emailService.sendAccountBlocked({
                  login: userData.login,
                  email: userEmail,
                  reason: "3 Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ",
                  supportUrl: config.SUPPORT_URL,
                  ipAddress: req.ip || "unknown",
                  userAgent: req.headers["user-agent"] || "",
                });
                console.log(
                  `ðŸ“§ ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð°: ${userEmail}`
                );
              } catch (emailError) {
                console.error(
                  "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ email Ð¾ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:",
                  emailError.message
                );
              }
            } catch (blockError) {
              console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ:", blockError.message);
            }

            return res.status(401).json({
              success: false,
              message:
                "ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº. ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð² Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ.",
            });
          }
        } catch (updateError) {
          console.warn(
            "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½ÑƒÑŽ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ:",
            updateError.message
          );
        }

        const remainingAttempts = 3 - (attemptCount + 1);
        let message = "ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾";
        if (remainingAttempts > 0) {
          message += `. ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº: ${remainingAttempts}`;
        }

        return res.status(400).json({
          success: false,
          message: message,
          field: "secretWord",
        });
      }

      // 10. Ð•ÑÐ»Ð¸ ÐºÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð’Ð•Ð ÐÐž - ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ð¾ EMAIL
      console.log(`âœ… ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð²ÐµÑ€Ð½Ð¾ Ð´Ð»Ñ ${login}`);
      try {
        await query("DELETE FROM password_reset_attempts WHERE email = ?", [
          userEmail,
        ]);
        console.log(`ðŸ”„ Ð’ÑÐµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ð´Ð»Ñ ${userEmail}`);
      } catch (deleteError) {
        console.warn("âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸:", deleteError.message);
      }

      // 11. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
      console.log(`ðŸ”‘ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð´Ð»Ñ ${login}`);
      const validPassword = await bcrypt.compare(
        currentPassword,
        userData.password
      );

      if (!validPassword) {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        console.log(`âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ ${login}`);

        return res.status(400).json({
          success: false,
          message: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ",
          field: "currentPassword",
        });
      }

      // 12. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾
      const samePassword = await bcrypt.compare(newPassword, userData.password);
      if (samePassword) {
        console.log(`âš ï¸ ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼ Ð´Ð»Ñ ${login}`);
        return res.status(400).json({
          success: false,
          message: "ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾",
          field: "newPassword",
        });
      }

      // 13. Ð¥ÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
      const salt = await bcrypt.genSalt(12);
      const hashedPassword = await bcrypt.hash(newPassword, salt);

      // 14. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð² Ð±Ð°Ð·Ðµ
      await query(
        "UPDATE usersdata SET password = ? WHERE login = ? AND logic = 'true'",
        [hashedPassword, login]
      );
      console.log(`âœ… ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${login}`);

      // 15. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐµÑÑÐ¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      await query("DELETE FROM sessionsdata WHERE login = ?", [login]);
      console.log(`ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ñ‹ Ð²ÑÐµ ÑÐµÑÑÐ¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${login}`);

      // 16. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ email ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
      try {
        await emailService.sendPasswordChanged({
          login: login,
          email: userEmail,
          userIp: req.ip || req.connection.remoteAddress,
          userAgent: req.headers["user-agent"] || "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾",
        });

        console.log(`ðŸ“§ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ ÑÐ¼ÐµÐ½Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð½Ð° ${userEmail}`);
      } catch (emailError) {
        console.error(
          "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ email ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:",
          emailError.message
        );
      }

      // 17. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑ…
      console.log(`âœ… Ð¡Ð¼ÐµÐ½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð´Ð»Ñ ${login}`);

      res.json({
        success: true,
        message: "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½",
        requireReauth: true,
        emailSent: true,
      });
    } catch (error) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ:", error);
      console.error("ðŸ“‹ Stack trace:", error.stack);

      if (error.name === "ValidationError") {
        return res.status(400).json({
          success: false,
          message: error.message,
          field: error.field,
        });
      }

      res.status(500).json({
        success: false,
        message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¼ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ",
      });
    }
  }
);

// Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
app.delete(
  "/api/settings/delete-account",
  authenticateToken,
  async (req, res) => {
    const connection = await getConnection();

    try {
      const login = req.user.login;

      console.log(`ðŸ—‘ï¸ ÐÐ°Ñ‡Ð°Ð»Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°: ${login}`);

      await connection.beginTransaction();

      try {
        await connection.execute(`DROP TABLE IF EXISTS \`${login}\``);
        console.log(`âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${login} ÑƒÐ´Ð°Ð»ÐµÐ½Ð°`);
      } catch (tableError) {
        console.warn(
          `âš ï¸ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${login} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°:`,
          tableError.message
        );
      }

      const sessionResult = await connection.execute(
        "DELETE FROM sessionsdata WHERE login = ?",
        [login]
      );
      console.log(`âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ ÑÐµÑÑÐ¸Ð¹: ${sessionResult[0].affectedRows}`);

      const userResult = await connection.execute(
        "DELETE FROM usersdata WHERE login = ? AND logic = 'true'",
        [login]
      );

      if (userResult[0].affectedRows === 0) {
        throw new Error("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² usersdata");
      }
      console.log(`âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${login} ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· usersdata`);

      const userDir = path.join(UPLOAD_DIR, login);
      try {
        await fs.access(userDir);
        await fs.rm(userDir, { recursive: true, force: true });
        console.log(`âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°: ${userDir}`);
      } catch (fsError) {
        console.warn(
          `âš ï¸ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: ${fsError.message}`
        );
      }

      await connection.commit();

      console.log(`âœ… ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ${login} Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»ÐµÐ½`);

      res.json({
        success: true,
        message: "ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½",
      });
    } catch (error) {
      await connection.rollback();

      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°:", error);

      res.status(500).json({
        success: false,
        message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°",
        details:
          process.env.NODE_ENV === "development" ? error.message : undefined,
      });
    } finally {
      connection.release();
    }
  }
);

// ==================== ÐÐ”ÐœÐ˜Ð API ====================
app.use("/api/admin", adminRoutes);

// =====================Ð¢Ð•Ð¥ÐŸÐžÐ”Ð”Ð•Ð Ð–ÐšÐ API ====================
app.use("/api/support", supportRoutes);

// ==================== ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ ÐžÐ¨Ð˜Ð‘ÐžÐš ====================
app.use((err, req, res, next) => {
  console.error("Global error handler:", err);

  if (err.name === "ValidationError") {
    return res.status(400).json({
      success: false,
      message: err.message,
      field: err.field,
    });
  }

  if (err.name === "JsonWebTokenError") {
    return res.status(401).json({
      success: false,
      message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸",
    });
  }

  res.status(500).json({
    success: false,
    message: "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°",
  });
});

// ==================== Ð’Ð¡Ð• ÐžÐ¡Ð¢ÐÐ›Ð¬ÐÐ«Ð• Ð—ÐÐŸÐ ÐžÐ¡Ð« â†’ REACT ====================
app.get("/admin*", (req, res) => {
  res.sendFile(path.join(adminBuildPath, "index.html"));
});

app.get("*", (req, res) => {
  res.sendFile(path.join(buildPath, "index.html"));
});

// ==================== Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ Ð˜ Ð—ÐÐŸÐ£Ð¡Ðš Ð¡Ð•Ð Ð’Ð•Ð Ð ====================
async function initializeServer() {
  try {
    await ensureUploadDirs();

    await emailService.initialize();

    await workerService.initWorkers();

    app.listen(PORT, () => {
      console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
      console.log(`â° Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°: ${new Date().toLocaleString()}`);

      startCleanupSchedule();
    });
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸:", error);
    process.exit(1);
  }
}

// ==================== GRACEFUL SHUTDOWN HANDLERS ====================
process.on("SIGTERM", async () => {
  console.log("ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ...");
  await workerService.shutdown();
  await emailService.close();
  process.exit(0);
});

process.on("SIGINT", async () => {
  console.log("ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ...");
  await workerService.shutdown();
  await emailService.close();
  process.exit(0);
});

process.on("uncaughtException", async (error) => {
  console.error("ðŸ’¥ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ðµ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:", error);
  await workerService.shutdown();
  await emailService.close();
  process.exit(1);
});

process.on("unhandledRejection", (reason, promise) => {
  console.error("ðŸ’¥ ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¸Ñ:", reason);
});

initializeServer();
